# Mise à jour du système
sudo apt update && sudo apt upgrade -y

# Installation des extensions PHP nécessaires
sudo apt install php-curl php-gd php-mbstring php-xml php-xmlrpc php-zip php-intl php-bz2 php-json php-cli php-apcu php-intl php-ldap -y

# Redémarrer Apache
sudo systemctl restart apache2

# Télécharger et installer GLPI
cd /var/www/html
sudo wget https://github.com/glpi-project/glpi/releases/download/10.0.12/glpi-10.0.12.tgz
sudo tar -xzvf glpi-10.0.12.tgz

# Permissions pour GLPI
sudo chown -R www-data:www-data /var/www/html/glpi
sudo chmod -R 755 /var/www/html/glpi

# Créer une base de données pour GLPI
sudo mysql -u root -p
CREATE DATABASE glpi CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
CREATE USER 'Admin'@'localhost' IDENTIFIED BY 'Azerty';
GRANT ALL PRIVILEGES ON glpi.* TO 'Admin'@'localhost';
FLUSH PRIVILEGES;
QUIT;

Initialiser sur le serveur web avant de supprimer le installphp

# Supprimer le fichier d'installation pour sécuriser GLPI
sudo rm /var/www/html/glpi/install/install.php


#pour securiser l'installation 
cd /var/www/html/glpi/install
sudo rm install.php

#Sécuriser le dossier racine du serveur web
sudo nano /etc/apache2/sites-available/glpi.conf
<Directory /var/www/html/glpi>
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

<Directory /var/www/html/glpi/files>
    Order Deny,Allow
    Deny from All
</Directory>

<Directory /var/www/html/glpi/config>
    Order Deny,Allow
    Deny from All
</Directory>

sudo systemctl restart apache2

#pour php
sudo nano /etc/php/8.2/apache2/php.ini

chercher : session.cookie_httponly = On

il doit être sur ON

sudo systemctl restart apache2

#securisation fichier critique hors du repertoire racine
cd /var/www/html/glpi
sudo mkdir -p /var/lib/glpi
sudo mv files /var/lib/glpi/
sudo mv config /var/lib/glpi/

sudo nano /var/lib/glpi/config/config_db.php
<?php
class DB extends DBmysql {
    public $dbhost = 'localhost';
    public $dbuser = 'glpiuser';
    public $dbpassword = 'Azerty123!';
    public $dbdefault = 'glpi';
    public $use_utf8mb4 = true;
    public $allow_myisam = false;
    public $allow_datetime = false;
    public $allow_signed_keys = false;
}

// Déplacement des répertoires sensibles
define('GLPI_ROOT_DOC', '/var/www/html/glpi');
define('GLPI_FILES_DIR', '/var/lib/glpi/files');
define('GLPI_CONFIG_DIR', '/var/lib/glpi/config');

sudo chown www-data:www-data /var/lib/glpi/config/config_db.php
sudo chmod 640 /var/lib/glpi/config/config_db.php


sudo chown -R www-data:www-data /var/lib/glpi/
sudo chmod -R 750 /var/lib/glpi/
sudo chmod 640 /var/lib/glpi/config/config_db.php

sudo nano /etc/apache2/sites-available/glpi.conf

<VirtualHost *:80>
    ServerName 172.16.1.4
    DocumentRoot /var/www/html/glpi

    <Directory /var/www/html/glpi>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/glpi-error.log
    CustomLog ${APACHE_LOG_DIR}/glpi-access.log combined
</VirtualHost>

sudo systemctl reload apache2

sudo rm -rf /var/www/html/glpi/config
sudo ln -s /var/lib/glpi/config /var/www/html/glpi/config
sudo chown -R www-data:www-data /var/lib/glpi/config
sudo chmod -R 750 /var/lib/glpi/config

sudo nano /var/lib/glpi/config/config_db.php
public $dbhost = 'localhost';
public $dbuser = 'glpiuser';
public $dbpassword = 'Azerty123%21';
public $dbdefault = 'glpi';


sudo chown -R www-data:www-data /var/lib/glpi/config
sudo chmod -R 750 /var/lib/glpi/config
sudo chown -R www-data:www-data /var/www/html/glpi/config
sudo chmod -R 750 /var/www/html/glpi/config
sudo systemctl restart apache2
sudo systemctl restart mysql


sudo systemctl reload apache2

/////////////////Depanage///////////////////
cd /tmp
wget https://github.com/glpi-project/glpi/releases/download/10.0.10/glpi-10.0.10.tgz
tar -xvzf glpi-10.0.10.tgz
sudo cp /tmp/glpi/install/install.php /var/www/html/glpi/install/
sudo chown -R www-data:www-data /var/www/html/glpi/install
sudo chmod -R 755 /var/www/html/glpi/install

sudo rm /var/lib/glpi/config/config_db.php
sudo rm -rf /var/www/html/glpi
sudo rm -rf /var/lib/glpi


