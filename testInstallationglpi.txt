# 2. Mise à jour système
sudo apt-get update && sudo apt-get upgrade -y

# 3. Installation Apache, DB, PHP
sudo apt-get install apache2 mariadb-server php libapache2-mod-php \
 php-curl php-mbstring php-xml php-gd php-zip php-cli php-bz2 php-intl php-ldap -y

# 4. Sécurisation MySQL/MariaDB
sudo mysql_secure_installation

# 5. Création de la base et utilisateur GLPI
sudo mysql -u root -p
CREATE DATABASE glpi CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'glpi_user'@'localhost' IDENTIFIED BY 'Azerty123!';
GRANT ALL PRIVILEGES ON glpi.* TO 'glpi_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 6. Installation GLPI
cd /tmp
wget https://github.com/glpi-project/glpi/releases/download/10.0.16/glpi-10.0.16.tgz
sudo tar -xvf glpi-10.0.16.tgz
sudo mv glpi /var/www/html/glpi
sudo chown -R www-data:www-data /var/www/html/glpi
sudo find /var/www/html/glpi -type d -exec chmod 750 {} \;
sudo find /var/www/html/glpi -type f -exec chmod 640 {} \;
sudo chmod -R 770 /var/www/html/glpi/files /var/www/html/glpi/config \
 /var/www/html/glpi/marketplace /var/www/html/glpi/plugins

# 7. Configuration Apache
sudo nano /etc/apache2/sites-available/glpi.conf

<VirtualHost *:80>
    ServerName glpi.alphatech.local
    DocumentRoot /var/www/html/glpi

    # Sécurisation du dossier GLPI : interdiction d'accès direct à certains répertoires critiques
    <Directory /var/www/html/glpi>
        Options FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Interdire l’accès direct à certains répertoires sensibles (par ex. config, files, marketplace…)
    <Directory /var/www/html/glpi/config>
        Order allow,deny
        Deny from all
    </Directory>

    <Directory /var/www/html/glpi/files>
        Order allow,deny
        Deny from all
    </Directory>

    <Directory /var/www/html/glpi/marketplace>
        Order allow,deny
        Deny from all
    </Directory>

    <Directory /var/www/html/glpi/plugins>
        Order allow,deny
        Deny from all
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/glpi_error.log
    CustomLog ${APACHE_LOG_DIR}/glpi_access.log combined
</VirtualHost>

# (Insérer la config VirtualHost, sécuriser répertoires, etc.)
sudo a2ensite glpi.conf
sudo a2enmod rewrite
sudo systemctl reload apache2
sudo systemctl restart apache2

# 8. (Optionnel) HTTPS via Let’s Encrypt
sudo apt-get install certbot python3-certbot-apache -y
sudo certbot --apache -d glpi.alphatech.local

# 9. Finalisation
# - Accéder via http(s)://glpi.alphatech.local/
# - Supprimer/renommer install/ après l’installation
# - Changer les mots de passe par défaut
